import request from '@/utils/axios/index';

export interface MessageData {
  id: string;
  time: string;
  content: string;
}

// 股票分析报告数据
const stockReport =
  '## 股票000001技术分析报告\n\n### 一、价格趋势分析\n\n基于2025年7月1日至10月14日的交易数据，000001呈现出明显的下跌趋势。该股从期初价格12.30元下跌至期末11.57元，期间累计下跌0.73元，跌幅达5.93%。从价格走势来看，该股在分析期间内经历了三个阶段：\n\n**下跌阶段（7月-8月）**：股价从12.30元附近开始震荡下行，期间最高触及13.33元，但未能有效突破，随后进入调整期。\n\n**震荡筑底阶段（9月）**：股价在11.27-12.00元区间内反复震荡，11.27元成为重要的阶段性低点，显示出一定的支撑力度。\n\n**反弹试探阶段（10月）**：近期股价从11.27元低点开始反弹，最新收盘价11.57元，较前期低点反弹约2.66%，但整体仍处于下行通道中。\n\n从日线级别观察，该股目前仍受制于下行趋势线的压制，需要有效突破12.00元关键阻力位才能确认趋势反转。\n\n### 二、技术指标解读\n\n**移动平均线系统**：\n根据价格数据推算，该股短期均线（5日、10日）目前位于11.40-11.50元区间，中期均线（20日、30日）在11.60-11.80元区间，长期均线（60日）约在12.00元附近。当前股价11.57元位于短期均线之上，但仍在中期和长期均线之下，表明短期虽有反弹，但中长期趋势仍然偏弱。\n\n**相对强弱指标（RSI）**：\n基于近期价格波动计算，RSI指标目前约在45-50区间，处于中性偏弱区域，既未进入超卖区间（30以下），也未达到超买区间（70以上），显示多空力量相对均衡，但空头仍略占优势。\n\n**MACD指标**：\n从价格数据推断，MACD指标的快慢线仍在零轴下方运行，但近期DIF有向上靠近DEA的趋势，柱状图缩窄，显示下跌动能有所减弱，但尚未形成明确的买入信号。\n\n**布林带分析**：\n股价目前运行在布林带中轨附近，布林带呈现收窄态势，表明波动率降低，可能预示着即将出现方向性选择。\n\n### 三、支撑阻力位分析\n\n**关键支撑位**：\n1. **首要支撑位：11.27元** - 此为近期最低点，也是9月份多次测试未破的重要支撑\n2. **次要支撑位：11.00元** - 心理整数关口，如跌破11.27元，此位置将提供下一道防线\n3. **强支撑位：10.50元** - 前期重要成交密集区\n\n**关键阻力位**：\n1. **近期阻力位：11.80-12.00元** - 20日、30日均线汇聚区域，也是前期震荡区间下沿\n2. **中期阻力位：12.50元** - 8月份震荡平台下沿\n3. **强阻力位：13.00-13.33元** - 前期高点区域，突破难度较大\n\n### 四、成交量分析\n\n成交量变化提供了重要的市场情绪参考：\n\n**成交量特征**：\n- 7-8月下跌期间：成交量相对平稳，显示抛压并不集中\n- 9月筑底期间：成交量萎缩，表明市场观望情绪浓厚\n- 10月反弹期间：成交量明显放大，最新交易日成交184万手，成交额21.24亿元，换手率0.95%\n\n**量价关系分析**：\n近期价涨量增的态势较为健康，10月14日成交量较前一日放大57.7%，配合价格上涨1.49%，显示有资金开始关注并介入。这种放量上涨的态势如果能够持续，将有利于反弹行情的延续。\n\n### 五、综合评估与投资建议\n\n**技术面综合评级：中性偏谨慎**\n\n**短期走势（1-2周）**：\n股价在11.27元获得支撑后展开技术性反弹，短期有望继续上探11.80-12.00元阻力区域。如能放量突破12.00元，则反弹空间有望进一步打开至12.50元。\n\n**中期走势（1-3个月）**：\n中期趋势仍然偏弱，需要观察能否有效站稳12.00元上方。如能成功突破并站稳，则中期下跌趋势有望得到扭转。\n\n**投资建议**：\n\n**对于持仓投资者**：\n- 轻仓者可在股价回调至11.30-11.40元支撑区间时适量加仓\n- 重仓者建议在11.80-12.00元阻力区间考虑减仓部分筹码，降低持仓成本\n\n**对于空仓投资者**：\n- 激进型：可在11.30-11.40元区间轻仓介入，止损位设在11.00元下方\n- 稳健型：建议等待股价有效突破12.00元并回踩确认后再考虑介入\n- 保守型：继续观望，等待更明确的中期趋势信号\n\n**仓位管理建议**：\n初始仓位不宜超过总资金的30%，采用分批建仓策略，避免一次性重仓介入。\n\n### 六、风险提示\n\n1. **技术风险**：当前股价仍处于下行趋势中，反弹能否持续存在不确定性\n2. **突破失败风险**：如股价在11.80-12.00元阻力区遇阻回落，可能再次测试11.27元支撑\n3. **成交量风险**：需要持续观察成交量配合情况，如出现缩量上涨需警惕\n4. **市场风险**：整体市场环境变化可能影响个股技术走势\n5. **时间风险**：临近季报披露期，基本面变化可能对技术走势产生影响\n\n**重要声明**：本技术分析报告仅基于历史价格和成交量数据进行，不构成任何投资建议。投资者应结合公司基本面、行业状况、市场环境等多方面因素综合判断，独立做出投资决策，并自行承担投资风险。股市有风险，投资需谨慎。';

// 平安银行基本面分析报告
const pinganBankReport =
  '## 平安银行（000001）基本面分析报告\n\n### 1. 公司基本信息分析\n\n**公司概况**\n平安银行是中国领先的股份制商业银行，在深圳证券交易所上市，股票代码000001。作为中国金融体系的重要组成部分，公司在零售银行业务方面具有显著优势，在股份制银行中处于前列地位。\n\n**市场表现分析**\n根据2025年5月28日至10月14日的数据显示：\n- 最新收盘价：¥11.57（2025年10月14日）\n- 期间最高价：¥13.33\n- 期间最低价：¥11.27\n- 期间涨幅：+0.35%，表现相对平稳\n- 近期交易活跃度提升，10月14日换手率达0.95%\n\n### 2. 财务状况评估\n\n**资产负债表质量**\n- **资产负债率**：91.3%，符合银行业特征，但需关注资产质量\n- **资产质量**：作为商业银行，高负债率属行业常态，但需重点关注不良贷款率等指标\n\n**财务稳健性**\n银行业特有的高杠杆经营模式使得财务健康度评估需要结合资产质量、资本充足率等专业指标进行综合判断。\n\n### 3. 盈利能力分析\n\n**核心盈利指标**\n- **净资产收益率(ROE)**：5.2%，处于银行业中等水平\n- **净利率**：35.8%，表现良好\n- **毛利率**：71.4%，显示较强的成本控制能力\n\n**盈利质量评估**\n从盈利指标看，平安银行保持了相对稳定的盈利能力，净利率水平在银行业中表现较好，但ROE水平仍有提升空间。\n\n### 4. 估值分析（人民币计价）\n\n**相对估值指标**\n- **市盈率(PE)**：8.5倍，低于银行业平均水平，估值相对合理\n- **市净率(PB)**：0.44倍，显著低于1，存在估值修复空间\n\n**估值吸引力**\n当前估值水平具有以下特点：\n- 市盈率处于历史相对低位\n- 市净率大幅折价，安全边际较高\n- 相对于银行业整体估值水平，具备一定吸引力\n\n### 5. 投资建议\n\n**综合评估**\n基于基本面分析，平安银行具有以下投资特点：\n\n**积极因素：**\n- 估值水平合理，安全边际较高\n- 品牌价值和市场地位稳固\n- 零售银行业务优势明显\n- 金融科技布局领先\n\n**风险因素：**\n- 宏观经济环境不确定性\n- 利率环境变化对净息差的影响\n- 信贷资产质量压力\n- 行业监管政策变化风险\n\n**投资建议：🟡 持有**\n\n**建议理由：**\n1. 当前估值水平具备一定安全边际，但缺乏强劲的上涨催化剂\n2. 银行业整体面临宏观经济压力，需要观察后续政策效果\n3. 建议现有持仓者继续持有，新进投资者可考虑分批建仓\n4. 重点关注后续季度财报中的资产质量指标和净息差变化\n\n**风险提示：** 投资者应密切关注宏观经济政策变化、利率环境调整以及公司资产质量变化，建议结合个人风险承受能力进行投资决策。\n\n---\n*数据来源：基于AKShare真实财务数据计算*\n*分析日期：2025年10月14日*\n*重要声明：本分析仅供参考，不构成投资建议*';

/**
 *  获取所有消息列表
 *  @returns type:MessageData[]
 */
export const fetchMessages = async () => {
  try {
    return await request.post('api/news/get/all');
  } catch (error) {
    console.log(error);
  }
};

/**
 *  获取测试用消息列表
 */
export const mockApiResponse = async () => {
  // 模拟网络请求延时
  await new Promise((resolve) => setTimeout(resolve, 1000));
  return {
    code: 0,
    data: [
      {
        id: '0001',
        time: '2025-10-14',
        content: stockReport,
      },
      {
        id: '0002',
        time: '2025-10-13',
        content: pinganBankReport,
      },
      {
        id: '0003',
        time: '2025-10-12',
        content: '## 宏观经济分析报告\n\n当前经济数据显示，通胀压力有所缓解，货币政策保持稳健...',
      },
      {
        id: '0004',
        time: '2025-10-11',
        content:
          '## 科技行业动态分析报告\n\n科技板块近期表现活跃，人工智能相关概念股受到市场关注...',
      },
      {
        id: '0005',
        time: '2025-10-10',
        content:
          '## 投资策略调整与资产配置建议\n\n基于当前市场环境，建议适当调整投资组合，增加防御性资产配置...',
      },
      {
        id: '0006',
        time: '2025-10-09',
        content:
          '## 债券市场分析与投资机会报告\n\n近期债券收益率有所上行，信用利差收窄，投资机会显现...',
      },
    ],
    msg: 'success',
  };
};

const cleanMarkdown = (content: string) => {
  if (!content) return '';

  return (
    content
      // 移除标题标记
      .replace(/^#{1,6}\s+/gm, '')
      // 移除粗体标记
      .replace(/\**(.*?)\*\*/g, '$1')
      .replace(/(.*?) /g, '$1')
      // 移除斜体标记
      .replace(/\*(.*?)\*/g, '$1')
      .replace(/(.*?) /g, '$1')
      // 移除代码标记
      .replace(/(.*?)`/g, '$1')
      // 移除链接标记
      .replace(/\[(.*?)]\(.*?\)/g, '$1')
      // 移除图片标记
      .replace(/!\[(.*?)]\(.*?\)/g, '$1')
      // 移除列表标记
      .replace(/^\s*[-*+]\s+/gm, '')
      .replace(/^\s*\d+\.\s+/gm, '')
      // 移除引用标记
      .replace(/^>\s+/gm, '')
      // 移除水平线
      .replace(/^[-* ]{3,}\s*$/gm, '')
      // 替换换行符为空格
      .replace(/\n/g, '')
      // 去除多余空格
      .replace(/\s+/g, '')
      .trim()
  );
};

export const truncateContent = (content: string, maxLength = 30) => {
  if (!content) return '';
  const cleanedContent = cleanMarkdown(content);
  if (cleanedContent.length <= maxLength) return cleanedContent;
  return cleanedContent.substring(0, maxLength) + '...';
};

export const extractTruncatedTitle = (content: string, maxLength = 13) => {
  const title = extractTitleFromContent(content);
  return truncateTitle(title, maxLength);
};

const truncateTitle = (title: string, maxLength = 13): string => {
  if (!title) return '无标题';
  if (title.length <= maxLength) return title;
  return title.substring(0, maxLength) + '...';
};

const extractTitleFromContent = (content: string): string => {
  if (!content) return '无标题';

  const titleMatch = content.match(/^##\s+(.+?)(?:\n|$)/);
  if (titleMatch && titleMatch[1]) {
    return titleMatch[1].trim();
  }

  const fallbackMatch = content.match(/^#\s+(.+?)(?:\n|$)/);
  if (fallbackMatch && fallbackMatch[1]) {
    return fallbackMatch[1].trim();
  }

  return '无标题';
};
